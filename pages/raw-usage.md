<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/raw-usage.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->
# Raw SQL Usage

Interactions with SqlLocalDB via a [SqlConnection](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlconnection).


## LocalDb package [![NuGet Status](http://img.shields.io/nuget/v/LocalDb.svg)](https://www.nuget.org/packages/LocalDb/)

https://nuget.org/packages/LocalDb/


## Schema and data

The snippets use the following helper class:

<!-- snippet: TestDbBuilder.cs -->
```cs
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Threading.Tasks;
using XunitLogger;

public class TestDbBuilder
{
    public static void CreateTable(SqlConnection connection)
    {
        using (var command = connection.CreateCommand())
        {
            command.CommandText = "create table MyTable (Value int);";
            command.ExecuteNonQuery();
        }
    }

    public static async Task<int> AddData(SqlConnection connection)
    {
        var nextInt = Counters.NextInt();
        using (var command = connection.CreateCommand())
        {
            command.CommandText = $@"
insert into MyTable (Value)
values ({nextInt});";
            await command.ExecuteNonQueryAsync();
        }
        return nextInt;
    }

    public static async Task<List<int>> GetData(SqlConnection connection)
    {
        var values = new List<int>();
        using (var command = connection.CreateCommand())
        {
            command.CommandText = "select Value from MyTable";
            var reader = await command.ExecuteReaderAsync();
            while (reader.Read())
            {
                values.Add(reader.GetInt32(0));
            }
        }
        return values;
    }
}
```
<sup>[snippet source](/src/LocalDb.Tests/TestDbBuilder.cs#L1-L44)</sup>
<!-- endsnippet -->


## Initialize SqlInstance

SqlInstance needs to be initialized once.

To ensure this happens only once there are several approaches that can be used:


### Static constructor

In the static constructor of a test.

If all tests that need to use the SqlInstance existing in the same test class, then the SqlInstance can be initialized in the static constructor of that test class.

<!-- snippet: StaticConstructor -->
```cs
public class Tests
{
    static SqlInstance sqlInstance;

    static Tests()
    {
        sqlInstance = new SqlInstance(
            name: "StaticConstructorInstance",
            buildTemplate: TestDbBuilder.CreateTable);
    }

    [Fact]
    public async Task Test()
    {
        using (var database = await sqlInstance.Build())
        {
            await TestDbBuilder.AddData(database.Connection);
            Assert.Single(await TestDbBuilder.GetData(database.Connection));
        }
    }
}
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/StaticConstructor.cs#L7-L31)</sup>
<!-- endsnippet -->


### Static constructor in test base

If multiple tests need to use the SqlInstance, then the SqlInstance should be initialized in the static constructor of test base class.

<!-- snippet: TestBase -->
```cs
public class TestBase
{
    static SqlInstance instance;

    static TestBase()
    {
        instance = new SqlInstance(
            name:"TestBaseUsage",
            buildTemplate: TestDbBuilder.CreateTable);
    }

    public Task<SqlDatabase> LocalDb(
        string databaseSuffix = null,
        [CallerMemberName] string memberName = null)
    {
        return instance.Build(GetType().Name, databaseSuffix, memberName);
    }
}

public class Tests:
    TestBase
{
    [Fact]
    public async Task Test()
    {
        using (var database = await LocalDb())
        {
            await TestDbBuilder.AddData(database.Connection);
            Assert.Single(await TestDbBuilder.GetData(database.Connection));
        }
    }
}
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/TestBaseUsage.cs#L8-L43)</sup>
<!-- endsnippet -->


## Usage in a Test

Usage inside a test consists of two parts:


### Build a SqlInstance

<!-- snippet: BuildLocalDbInstance -->
```cs
using (var database = await instance.Build())
{
    await TestDbBuilder.AddData(database.Connection);
    Assert.Single(await TestDbBuilder.GetData(database.Connection));
}
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/SnippetTests.cs#L20-L28)</sup>
<!-- endsnippet -->


### Build Signature

The signature is as follows:

<!-- snippet: BuildSignature -->
```cs
/// <summary>
///   Build DB with a name based on the calling Method.
/// </summary>
/// <param name="testFile">The path to the test class. Used to make the db name unique per test type.</param>
/// <param name="databaseSuffix">For Xunit theories add some text based on the inline data to make the db name unique.</param>
/// <param name="memberName">Used to make the db name unique per method. Will default to the caller method name is used.</param>
public Task<SqlDatabase> Build(
    [CallerFilePath] string testFile = null,
    string databaseSuffix = null,
    [CallerMemberName] string memberName = null)
```
<sup>[snippet source](/src/LocalDb/SqlInstance.cs#L44-L55)</sup>
<!-- endsnippet -->


### Database Name

The database name is the derived as follows:

<!-- snippet: DeriveName -->
```cs
var dbName = $"{testClass}_{memberName}";
if (databaseSuffix != null)
{
    dbName = $"{dbName}_{databaseSuffix}";
}
```
<sup>[snippet source](/src/LocalDb/DbNamer.cs#L5-L13)</sup>
<!-- endsnippet -->

There is also an override that takes an explicit dbName:

<!-- snippet: WithDbName -->
```cs
using (var database = await instance.Build("TheTestWithDbName"))
{
    await TestDbBuilder.AddData(database.Connection);
    Assert.Single(await TestDbBuilder.GetData(database.Connection));
}
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/SnippetTests.cs#L35-L41)</sup>
<!-- endsnippet -->


### Using SQLConnection

<!-- snippet: BuildContext -->
```cs
await TestDbBuilder.AddData(database.Connection);
Assert.Single(await TestDbBuilder.GetData(database.Connection));
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/SnippetTests.cs#L23-L26)</sup>
<!-- endsnippet -->


### Full Test

The above are combined in a full test:

<!-- snippet: SnippetTests.cs -->
```cs
using System.Threading.Tasks;
using EfLocalDb;
using Xunit;

public class EfSnippetTests
{
    static SqlInstance<MyDbContext> sqlInstance;
    static EfSnippetTests()
    {
        sqlInstance = new SqlInstance<MyDbContext>(
            builder => new MyDbContext(builder.Options));
    }

    #region EfTest

    [Fact]
    public async Task TheTest()
    {
        #region EfBuildLocalDbInstance
        using (var database = await sqlInstance.Build())
        {
            #endregion

            #region EfBuildContext
            using (var dbContext = database.NewDbContext())
            {
                #endregion
                var entity = new TheEntity
                {
                    Property = "prop"
                };
                dbContext.Add(entity);
                dbContext.SaveChanges();
            }

            using (var dbContext = database.NewDbContext())
            {
                Assert.Single(dbContext.TestEntities);
            }
        }
    }

    #endregion

    [Fact]
    public async Task TheTestWithDbName()
    {
        #region EfWithDbName
        using (var database = await sqlInstance.Build("TheTestWithDbName"))
        {
            #endregion
            var entity = new TheEntity
            {
                Property = "prop"
            };
            await database.AddData(entity);

            Assert.Single(database.Context.TestEntities);
        }
    }
}
```
<sup>[snippet source](/src/EfLocalDb.Tests/Snippets/EfSnippetTests.cs#L1-L61)</sup>
```cs
using System.Threading.Tasks;
using LocalDb;
using Xunit;

public class SnippetTests
{
    static SqlInstance instance;

    static SnippetTests()
    {
        instance = new SqlInstance(
            name: "Snippets",
            buildTemplate: TestDbBuilder.CreateTable);
    }

    #region Test

    public async Task TheTest()
    {
        #region BuildLocalDbInstance
        using (var database = await instance.Build())
        {
            #region BuildContext
            await TestDbBuilder.AddData(database.Connection);
            Assert.Single(await TestDbBuilder.GetData(database.Connection));
            #endregion
        }
        #endregion
    }

    #endregion

    public async Task TheTestWithDbName()
    {
        #region WithDbName
        using (var database = await instance.Build("TheTestWithDbName"))
        {
            await TestDbBuilder.AddData(database.Connection);
            Assert.Single(await TestDbBuilder.GetData(database.Connection));
        }
        #endregion
    }
}
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/SnippetTests.cs#L1-L43)</sup>
<!-- endsnippet -->
