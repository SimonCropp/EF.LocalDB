<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /pages/mdsource/directory-and-name-resolution.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->
# SqlLocalDB Directory and Instance Name Resolution

The instance name is defined as:

<!-- snippet: GetInstanceName -->
```cs
if (scopeSuffix == null)
{
    return typeof(TDbContext).Name;
}

return $"{typeof(TDbContext).Name}_{scopeSuffix}";
```
<sup>[snippet source](/src/EfLocalDb/SqlInstance.cs#L131-L140)</sup>
<!-- endsnippet -->

That InstanceName is then used to derive the data directory. In order:

 * If `LocalDBData` environment variable exists then use `LocalDBData\InstanceName`.
 * If `AGENT_TEMPDIRECTORY` environment variable exists then use `AGENT_TEMPDIRECTORY\LocalDb\InstanceName`.
 * Use `%TempDir%\LocalDb\InstanceName`.

There is an explicit registration override that takes an instance name and a directory for that instance:


## For SQL:

<!-- snippet: ExplicitName -->
```cs
var sqlInstance = new SqlInstance(
    name: "theInstanceName",
    buildTemplate: TestDbBuilder.CreateTable,
    directory: @"C:\LocalDb\theInstance"
);
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/LocalDbLoggingUsage.cs#L7-L13)</sup>
<!-- endsnippet -->


## For EF:

<!-- snippet: EfExplicitName -->
```cs
var sqlInstance = new SqlInstance<TheDbContext>(
    constructInstance: builder => new TheDbContext(builder.Options),
    name: "theInstanceName",
    directory: @"C:\LocalDb\theInstance");
```
<sup>[snippet source](/src/EfLocalDb.Tests/Snippets/EfExplicitName.cs#L7-L12)</sup>
<!-- endsnippet -->


# Database Name Resolution

A design goal is to have an isolated database per test. To facilitate this the `SqlInstance.Build` method has a convention based approach. It contains the following parameters:

 * `testFile`: defaults to the full path of the source file that contains the caller via [CallerFilePathAttribute](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.compilerservices.callerfilepathattribute).
 * `memberName`: defaults to the method name of the caller to the method via [CallerMemberName](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.compilerservices.callermembername).
 * `databaseSuffix`: an optional parameter to further uniquely a database name when the `testFile` and `memberName` are not sufficient. For example when using parameterized tests.

The convention signature is as follows:

<!-- snippet: ConventionBuildSignature -->
```cs
/// <summary>
///   Build database with a name based on the calling Method.
/// </summary>
/// <param name="testFile">The path to the test class. Used to make the database name unique per test type.</param>
/// <param name="databaseSuffix">For Xunit theories add some text based on the inline data to make the db name unique.</param>
/// <param name="memberName">Used to make the db name unique per method. Will default to the caller method name is used.</param>
public Task<SqlDatabase> Build(
    [CallerFilePath] string testFile = null,
    string databaseSuffix = null,
    [CallerMemberName] string memberName = null)
```
<sup>[snippet source](/src/LocalDb/SqlInstance.cs#L54-L65)</sup>
<!-- endsnippet -->

With these parameters the database name is the derived as follows:

<!-- snippet: DeriveName -->
```cs
public static string DeriveDbName(string databaseSuffix, string memberName, string testClass)
{
    if (databaseSuffix == null)
    {
        return $"{testClass}_{memberName}";
    }
    return $"{testClass}_{memberName}_{databaseSuffix}";
}
```
<sup>[snippet source](/src/LocalDb/DbNamer.cs#L3-L12)</sup>
<!-- endsnippet -->


## Explicit name

If full control over the database name is required, there is an overload that takes an explicit name:

<!-- snippet: ExplicitBuildSignature -->
```cs
/// <summary>
///   Build database with an explicit name.
/// </summary>
public async Task<SqlDatabase> Build(string dbName)
```
<sup>[snippet source](/src/LocalDb/SqlInstance.cs#L78-L83)</sup>
<!-- endsnippet -->

Which can be used as follows:


### For SQL:

<!-- snippet: WithDbName -->
```md
using (var database = await sqlInstance.Build("TheTestWithDbName"))
{
    await TestDbBuilder.AddData(database.Connection);
    Assert.Single(await TestDbBuilder.GetData(database.Connection));
}
```
<sup>[snippet source](/pages/raw-usage.md#L305-L311)</sup>
```cs
using (var database = await sqlInstance.Build("TheTestWithDbName"))
{
    await TestDbBuilder.AddData(database.Connection);
    Assert.Single(await TestDbBuilder.GetData(database.Connection));
}
```
<sup>[snippet source](/src/LocalDb.Tests/Snippets/SnippetTests.cs#L35-L41)</sup>
<!-- endsnippet -->


### For EF:

<!-- snippet: EFWithDbName -->
```md
using (var database = await sqlInstance.Build("TheTestWithDbName"))
{
```
<sup>[snippet source](/pages/ef-usage.md#L248-L251)</sup>
```md
using (var database = await sqlInstance.Build("TheTestWithDbName"))
{
```
<sup>[snippet source](/pages/raw-usage.md#L254-L257)</sup>
```cs
using (var database = await sqlInstance.Build("TheTestWithDbName"))
{
```
<sup>[snippet source](/src/EfLocalDb.Tests/Snippets/EfSnippetTests.cs#L48-L51)</sup>
<!-- endsnippet -->
